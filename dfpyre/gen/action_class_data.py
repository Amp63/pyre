"""
Contains data and functions for Codeblock class generation.
"""

import re
import keyword
from datetime import datetime, timezone


OUTPUT_PATH = 'dfpyre/export/action_classes.py'
TEMPLATES_PATH = 'scripts/script_templates'

INDENT = ' ' * 4

def load_template(file_name: str):
    path = TEMPLATES_PATH + '/' + file_name
    with open(path, 'r') as f:
        return f.read()


EVENT_TEMPLATE = load_template('event.txt')
ACTION_TEMPLATE = load_template('action.txt')
NOTARGET_ACTION_TEMPLATE = load_template('notarget_action.txt')
CONDITIONAL_TEMPLATE = load_template('conditional.txt')
NOTARGET_CONDITIONAL_TEMPLATE = load_template('notarget_conditional.txt')
REPEAT_TEMPLATE = load_template('repeat.txt')
REPEAT_WHILE_TEMPLATE = load_template('repeat_while.txt')
SELECT_OBJ_TEMPLATE = load_template('select_obj.txt')


# Method name replacements

ENTITY_ACTION_REPLACEMENTS = {
    'SetAge/Size': ['SetAge_Size']
}

SET_VAR_REPLACEMENTS = {
    '+': ['Add'],
    '-': ['Subtract', 'Minus'],
    '%': ['Mod', 'Modulo', 'Remainder'],
    'x': ['Multiply'],
    '/': ['Divide'],
    '=': ['Assign', 'Equals', 'Set'],
    '+=': ['Increment'],
    '-=': ['Decrement'],
}

IF_VAR_REPLACEMENTS = {
    '=': ['Equals'],
    '!=': ['NotEqual'],
    '<': ['LessThan'],
    '<=': ['LessEqual'],
    '>': ['GreaterThan'],
    '>=': ['GreaterEqual'],
    'Legacy !=': [],
    'Legacy =': [],
    ' = ': []
}

SELECT_OBJ_REPLACEMENTS = {
    'None': ['SelectNone']
}


CODEBLOCK_LOOKUP: dict[str, tuple[str, str, dict[str, list[str]]]] = {
    'event': ('PlayerEvent', EVENT_TEMPLATE, {}),
    'entity_event': ('EntityEvent', EVENT_TEMPLATE, {}),
    'player_action': ('PlayerAction', ACTION_TEMPLATE, {}),
    'game_action': ('GameAction', NOTARGET_ACTION_TEMPLATE, {}),
    'entity_action': ('EntityAction', ACTION_TEMPLATE, ENTITY_ACTION_REPLACEMENTS),
    'if_player': ('IfPlayer', CONDITIONAL_TEMPLATE, {}),
    'if_var': ('IfVariable', NOTARGET_CONDITIONAL_TEMPLATE, IF_VAR_REPLACEMENTS),
    'if_game': ('IfGame', NOTARGET_CONDITIONAL_TEMPLATE, {}),
    'if_entity': ('IfEntity', CONDITIONAL_TEMPLATE, {}),
    'repeat': ('Repeat', REPEAT_TEMPLATE, {}),
    'control': ('Control', NOTARGET_ACTION_TEMPLATE, {}),
    'select_obj': ('SelectObject', SELECT_OBJ_TEMPLATE, SELECT_OBJ_REPLACEMENTS),
    'set_var': ('SetVariable', NOTARGET_ACTION_TEMPLATE, SET_VAR_REPLACEMENTS)
}


PARAM_TYPE_LOOKUP = {
    'TEXT': ['DFString'],
    'COMPONENT': ['DFText'],
    'NUMBER': ['Number'],
    'VARIABLE': ['Variable'],
    'ITEM': ['Item'],
    'LOCATION': ['Location'],
    'VECTOR': ['DFVector'],
    'LIST': ['ArgValue'],
    'DICT': ['ArgValue'],
    'BYTE': ['Number | int'],
    'SOUND': ['Sound'],
    'POTION': ['Potion'],
    'PARTICLE': ['Particle'],
    'BLOCK': ['Item'],
    'PROJECTILE': ['Item'],
    'VEHICLE': ['Item'],
    'SPAWN_EGG': ['Item'],
    'ENTITY_TYPE': ['Item'],
    'ANY_TYPE': ['ArgValue'],
    'BLOCK_TAG': ['DFString'],
    'NONE': ['None'],
}


PARAM_NAME_REPLACEMENTS = {
    'component': 'text'
}


IMPORTS = [
    f'# Auto generated by pyre {datetime.now(timezone.utc).isoformat()}',
    'from typing import Literal',
    'from dfpyre.core.codeblock import CodeBlock, Target, DEFAULT_TARGET',
    'from dfpyre.core.items import ArgValue, Item, String as DFString, Text as DFText, Number, Variable, Location, Sound, Particle, Potion, Vector as DFVector',
    'from dfpyre.export.block_functions import assemble_template, add_brackets',
    'from dfpyre.gen.action_literals import SUBACTION',
    f"__all__ = {[t[0] for t in CODEBLOCK_LOOKUP.values()]}"
]


def to_valid_identifier(s):
    if not s:
        return "_"
    
    result = s.replace(" ", "_").replace("-", "_")
    result = re.sub(r'[^\w]', '_', result)
    result = re.sub(r'_+', '_', result)
    
    if result[0].isdigit():
        result = "_" + result
    
    result = result.strip("_")
    
    if not result:
        return "_"
    
    if keyword.iskeyword(result):
        result += "_"
    
    return result


def get_method_name_and_aliases(codeblock_type: str, action_name: str) -> tuple[str, list[str]] | None:
    codeblock_data = CODEBLOCK_LOOKUP.get(codeblock_type)
    if codeblock_data is None:
        return None
    
    method_replacements = codeblock_data[2]
    method_aliases: list[str] = []
    if action_name in method_replacements:
        replacements = method_replacements[action_name]
        if not replacements:
            # Intentionally skipped action
            return None
        method_name = replacements[0]
        method_aliases = replacements[1:]
    else:
        method_name = to_valid_identifier(action_name)
        if method_name.startswith('_'):
            # Probably an action surrounded with spaces, so skip
            return None
    
    return method_name, method_aliases
